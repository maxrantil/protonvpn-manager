name: Issue AI Attribution Check
on:
  issues:
    types: [opened, edited]

jobs:
  check-attribution:
    name: Detect AI Attribution in Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check for AI attribution markers
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title || '';
            const combined = title + '\n' + body;

            // Pattern to detect AI tool attribution and agent mentions
            const aiPatterns = [
              /Co-authored-by:.*(Claude|GPT|ChatGPT|Copilot|Gemini|Bard|AI Assistant)/i,
              /Generated with.*(Claude|AI|GPT|ChatGPT|Copilot)/i,
              /claude\.com\/claude-code/i,
              /Created by (Claude|ChatGPT|GPT|Copilot|AI)/i,
              /Written by (Claude|ChatGPT|GPT|Copilot|AI)/i,
              /(Reviewed by|Validated by|Approved by|Checked by).*(agent|architecture-designer|security-validator|performance-optimizer|test-automation-qa|code-quality-analyzer|documentation-knowledge-manager|ux-accessibility-i18n-agent|devops-deployment-agent|general-purpose-agent)/i,
              /agent (review|validation|approval|check)/i,
            ];

            let foundAttribution = false;
            let matchedPattern = '';

            for (const pattern of aiPatterns) {
              if (pattern.test(combined)) {
                foundAttribution = true;
                matchedPattern = pattern.toString();
                break;
              }
            }

            if (foundAttribution) {
              const comment = `❌ **AI/Agent Attribution Detected**

              This issue contains AI tool or agent attribution, which is against project policy.

              **Found pattern**: ${matchedPattern}

              **Policy**: Per CLAUDE.md Section 1, AI/agent attribution should NOT be in:
              - ❌ Issue descriptions
              - ❌ Commit messages
              - ❌ Pull request descriptions

              **Where agent validations SHOULD be documented:**
              - ✅ Session handoff files (SESSION_HANDOVER.md)
              - ✅ Implementation documentation (docs/implementation/)
              - ✅ PRD/PDR documents
              - ✅ PR comments (workflow progress updates)

              **Why this policy?**
              - Issues/PRs should describe problems/solutions, not authorship
              - AI tools and agents are development aids, not contributors
              - Focus on content, not creation method
              - Agent validations belong in internal documentation

              **Action Required**: Please edit this issue to remove AI/agent attribution references.

              **Note**: Human co-authors are welcome and encouraged!`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });

              // Add label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-revision']
              });

              core.setFailed('AI attribution detected in issue');
            } else {
              console.log('✅ No AI attribution found in issue');
            }
